<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>2048</title>
<style>
ul,li{ margin:0; padding:0; border-radius:6px;}
ul{ list-style:none;
	width:225px;
	height:225px;
	background:#bbada0;
	position:relative;}
li{ width:50px; height:50px;
	background:#ccc0b3;
	float:left;
	margin: 5px 0 0 5px;
	font:24px/50px "黑体";
	text-align:center;
	font-weight:bolder;}
.number{background:#eee3da;
	z-index:1;
	position:absolute;}
.n4{background:#ede0c8;}
.n8{background:#f2b179;}
.n16{background:#f59563;}
.n32{background:#f67c5f;}
.n64{background:#f65e3b;}
.n128{background:#edcf72;}
.n256{background:#edcc61;}
.n512{background:#9c0;}
.n1024{background:#33b5e5;}
.n2048{background:#09c;}
.n4096{background:#a6c;}
.n8192{background:#93c;}
</style>
<script src="http://apps.bdimg.com/libs/jquery/2.1.1/jquery.min.js"></script>
<script>
$(function(){
	var arr = [];
//  1.布局
	function layOut(){
		for(var i=0;i<16;i++){
			$('<li></li>').appendTo('ul');
		}
		
		for(var i=0;i<$('li').length;i++){
			arr.push({"l":Math.ceil($('li:eq('+ i +')').position().left),
				"t":Math.ceil($('li:eq('+ i +')').position().top)});
			$('li:eq('+ i +')').css({"left":arr[i].l + "px", "top":arr[i].t + "px"});
		}
		
		$('li').css({"position":"absolute"});			
	}
	
//2.获取不重复的随机位置	
	//2.1获取当前所有数字方块位置的数组
	function gridArr(){
		var arrNum = [];
		for(var i=0;i<$('.number').length;i++){
			arrNum.push({"l" : Math.round($('.number:eq('+ i +')').position().left),
						 "t" : Math.round($('.number:eq('+ i +')').position().top)});			
		}
		return arrNum;		
	}

	//2.2返回一个随机的空位置
	function randomArray(){	
		var arr2 = arr.concat([]);
		var arrNum = gridArr();
	//除去存在的方块后，返回剩余中的一个随机位置
		for(var i=0;i<arrNum.length;i++){
			for(var j=0;j<arr2.length;j++){
				if(arrNum[i].l == arr2[j].l && arrNum[i].t == arr2[j].t){
					arr2.splice(j,1);
				}
			}
		}
		return arr2[Math.floor(Math.random()*arr2.length)];
	}
	//3.添加新数字方块
	function createGrid(){
		var arr = randomArray();
		var oGrid = $('<li></li>');
		oGrid.html(Math.random()>0.2?2:4);
		oGrid.addClass("number").addClass("n" + oGrid.html());
		
		if($('.number').length<16){
			oGrid.css({"left":arr.l + "px","top":arr.t + "px"});
			oGrid.appendTo('ul');
		}
	}
	
//获取同行或列的方块元素,并按升序排列
//	返回一个数组，数组为全部行（列）数字方块元素的集合
	function getPosition(dir){
		var arr = [];
		var dir2 = dir == "left"?"top":"left";
		for(var j=0;j<4;j++){
			var arr1 = [],
				arr2 = [];
			for(var i=0;i<$('.number').length;i++){
				if(Math.round($('.number:eq('+ i +')').position()[dir]) == j*55){
					arr1.push($('.number:eq('+ i +')'));
				}
			}
			
			arr2 = arr1.sort(function(a,b){
				return a.position()[dir2] - b.position()[dir2];
			});
			arr.push(arr2);
			
		}
		return arr;
	}
	
//		改变颜色
	function changeColor(obj){
		var num = obj.html();
		var b = obj.attr('class').split(" ");
		if(b.length>0){
			obj.removeClass(b[1]).addClass("n" + num);
		}
		
	}
	
/*全部行（列）移动
4.判断能否合并;
4.1 不能 按顺序排列
4.2 能   计算每个合并后的坐标，（回调中完成 移动完成后目标方块数字值翻倍，删除被合并的方块）
*/
//	定义开关ended监控运动是否完成
	var ended = true;
//	定义开关needcreate监控是否满足生成方块条件
	var needcreate = false;
//		全部行（列）移动
//		接收参数arr为单行（列）方块元素的集合
	//	move(arr,index,json,true);  true:表示向下或向右

	function move(arr,num,dir,Reverse,endFn){
		var json = {};
		var a;
		for(var i=0;i<arr.length;i++){
			ended = false;
			if(!Reverse){
				a = i;
				if(num.length == 2){
					json[dir] = i<=1?"0px":"55px";
				}else if(num.length == 1){
					json[dir] = i>num[0]?(i-1)*55 + "px":i*55 + "px";
				}else{
					json[dir] = i*55 + "px";
				}
				
			}else{
				a = arr.length-1-i;
				if(num.length == 2){
					json[dir] = i<=1?"165px":"110px";
				}else if(num.length == 1){
					json[dir] = i>(3-num[0])?(4-i)*55 + "px":(3-i)*55 + "px";
				}else{
					json[dir] = (3-i)*55 + "px";
				}
			}
			arr[a].animate(json,150,"swing",function(){
				ended = true;
				endFn && endFn();
			});	

		}
		
		(function(arr,num){
			var a = 0;
			var timer = setInterval(function(){
				a += 30;
				if(a>200){
					clearInterval(timer);
				}
				if(ended){
					for(var i=0;i<num.length;i++){
						arr[ num[i] ].html( arr[ num[i] ].html()*2 );
						changeColor(arr[ num[i] ]);
						!Reverse?arr[ num[i]+1 ].remove():arr[ num[i]-1 ].remove();
						clearInterval(timer);
					}
				}
				
			},30)			
		})(arr,num);
		
	}
	
	function goDir(dir,Reverse){
		var dir2 = dir == "left"?"top":"left";
		var arr = getPosition(dir2);
		var a,b,c,d;
		Reverse = Reverse || false;
		needcreate = false;
		
		for(var i=0;i<arr.length;i++){
			if(arr[i].length == 0){
				continue;
			}
			//		定义num:存放数字翻倍的方块的index
			var num = [];
			for(var j=0;j<arr[i].length;j++){
				if(!Reverse){
					a = b = j;
					c = j;
					d = j+1;
				}else{
					a = arr[i].length-1-j;
					b = 3-j;
					c = arr[i].length-1-j;
					d = arr[i].length-2-j;
				}
				
				if(Math.round(arr[i][a].position()[dir]) !== b*55){
					needcreate = true;
				}
				
				if( arr[i][d] && arr[i][c].html() == arr[i][d].html() ){
					needcreate = true;
					num.push(c);
					j++;
				}
				
			}
			move(arr[i],num,dir,Reverse);
			
		}
	}
	
	function cGrid(){
		var a = 0;
		var timer = setInterval(function(){
			a += 30
			if(a>200){
				clearInterval(timer);
			}
			if(ended && needcreate){
				createGrid();
				clearInterval(timer);
			}
			
		},30);
	}
	
	$(document).keydown(function(event){
		var a = event.keyCode;
		if(a == 37||a == 38||a == 39||a == 40){
			if(ended){
				switch (a){
					case 37:
					goDir("left");
					break;
					case 38:
					goDir("top");
					break;
					case 39:
					goDir("left",true);
					break;
					case 40:
					goDir("top",true);
					break;
				}
				cGrid();
				gameOver();
			}
			
		}
	});
	
	function finished(arr){
		var notOver = false;
		for(var i=0;i<arr.length;i++){
			for(var j=0;j<arr[i].length-1;j++){
				if(arr[i][j].html() == arr[i][j+1].html()){
					notOver = true;
				}
			}
		}
		return notOver;				
	}
			
	function gameOver(){
		if($('.number').length >= 16){
			if(!needcreate){
				var arr1 = getPosition("left");
				var arr2 = getPosition("top");
				if(!finished(arr1) && !finished(arr2)){
					alert("Game Over")
					window.location.reload();
					newGame();	
				}
				
			}
		}
		
	}
	
	function newGame(){
		layOut();
		createGrid();
		createGrid();
	}
	
	newGame();
	
	$('#btn1').click(function(){
		window.location.reload();
		setTimeout(function(){
			newGame();
		},300)
		
	});
});
</script>
</head>

<body>
<!--操作：使用键盘方向键，四个方向移动
规则：游戏开始时：随机选择2个位置生成2或4
              每次移动：1.都判断移动方向上是否存在可合并的单元格
                      2.如果当前单元格之前存在相同数值得单元格，就累加； 如果前单元格之前有空单元格，就向前移动，直到碰到第一个不为空的单元格停止
                      3.每次移动后，如果存在空单元格，就随机选择空单元格生成一2或者4的随机数；   如果本次未发生移动，但游戏还可继续，不生成新随机数
                      4.游戏结束：每次移动后判断   ；四个方向均无法移动--》游戏结束-->
	<ul>
    	<!--<li class="number" style="left:0px;top:165px;position:absolute;">1</li>
    	<li class="number" style="left:55px;top:165px;position:absolute">5</li>
    	<li class="number" style="left:110px;top:110px;position:absolute">3</li>
    	<li class="number" style="left:110px;top:165px;position:absolute">7</li>
    	<li class="number" style="left:165px;top:165px;position:absolute">6</li>    	<li class="number" style="left:0px;top:55px;position:absolute;">9</li>
    	<li class="number" style="left:55px;top:55px;position:absolute">11</li>
    	<li class="number" style="left:110px;top:0px;position:absolute">10</li>
    	<li class="number" style="left:110px;top:55px;position:absolute">13</li>
    	<li class="number" style="left:165px;top:0px;position:absolute">15</li>-->
    </ul>
    <input type="button" id="btn1" value="new game">
</body>
</html>
